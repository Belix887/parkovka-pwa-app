# План реализации: Рейтинги, Отзывы и Избранное

## Обзор
Реализация системы рейтингов и отзывов для парковочных мест, а также функционала избранного для пользователей.

---

## 1. Рейтинги и Отзывы

### 1.1. Схема базы данных

**Модель Review:**
```prisma
model Review {
  id            String   @id @default(cuid())
  spotId        String
  spot          ParkingSpot @relation(fields: [spotId], references: [id], onDelete: Cascade)
  renterId      String
  renter        User     @relation("RenterReviews", fields: [renterId], references: [id])
  bookingId     String?  @unique // Связь с бронированием (один отзыв на бронирование)
  booking       Booking? @relation(fields: [bookingId], references: [id])
  
  rating        Int      // 1-5 звезд
  title         String?  // Заголовок отзыва
  comment       String   // Текст отзыва
  photos        ReviewPhoto[]
  
  // Ответ владельца
  ownerResponse String?
  ownerResponseAt DateTime?
  
  // Модерация
  status        ReviewStatus @default(PENDING)
  moderatedAt   DateTime?
  moderatorId   String?
  moderator     User?    @relation("ModeratorReviews", fields: [moderatorId], references: [id])
  
  // Полезность отзыва
  helpfulCount  Int      @default(0)
  reportedCount Int     @default(0)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([spotId])
  @@index([renterId])
  @@index([status])
  @@index([rating])
}

model ReviewPhoto {
  id        String  @id @default(cuid())
  reviewId  String
  review    Review  @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  url       String
  sortOrder Int     @default(0)
  
  @@index([reviewId])
}

enum ReviewStatus {
  PENDING      // На модерации
  APPROVED     // Одобрен
  REJECTED     // Отклонен
  HIDDEN       // Скрыт (после жалоб)
}

// Обновить модель ParkingSpot
// Добавить вычисляемые поля через Prisma (или в API):
// - averageRating (Float)
// - reviewCount (Int)
```

**Обновить модель Booking:**
```prisma
model Booking {
  // ... существующие поля
  review       Review?  @relation // Связь с отзывом
}
```

**Обновить модель User:**
```prisma
model User {
  // ... существующие поля
  reviews      Review[] @relation("RenterReviews")
  moderatedReviews Review[] @relation("ModeratorReviews")
}
```

### 1.2. API Endpoints

#### 1.2.1. Создание отзыва
**POST /api/reviews**
- Требуется авторизация
- Только после завершенного бронирования
- Один отзыв на одно бронирование
- Валидация: rating 1-5, comment минимум 10 символов
- Автомодерация (проверка на спам, мат)

#### 1.2.2. Получение отзывов места
**GET /api/spots/[id]/reviews**
- Параметры: `page`, `limit`, `sort` (newest, oldest, highest, lowest)
- Возвращает список отзывов с пагинацией
- Включает информацию о рейтере (имя, аватар)
- Статистика: средний рейтинг, количество отзывов

#### 1.2.3. Обновление отзыва
**PATCH /api/reviews/[id]**
- Только автор отзыва
- В течение 24 часов после создания
- Требуется модерация изменений

#### 1.2.4. Удаление отзыва
**DELETE /api/reviews/[id]**
- Только автор или модератор
- Мягкое удаление (status = HIDDEN)

#### 1.2.5. Ответ владельца
**POST /api/reviews/[id]/response**
- Только владелец места
- Один ответ на отзыв
- Валидация: максимум 1000 символов

#### 1.2.6. Полезность отзыва
**POST /api/reviews/[id]/helpful**
- Отметить отзыв как полезный
- Один голос на пользователя

#### 1.2.7. Жалоба на отзыв
**POST /api/reviews/[id]/report**
- Причина жалобы
- Модерация администратором

### 1.3. UI Компоненты

#### 1.3.1. Компонент рейтинга
**src/components/reviews/RatingStars.tsx**
- Отображение звезд (1-5)
- Режимы: только просмотр, редактирование
- Анимация при наведении

#### 1.3.2. Форма создания отзыва
**src/components/reviews/ReviewForm.tsx**
- Выбор рейтинга (звезды)
- Поле заголовка (опционально)
- Текстовое поле комментария
- Загрузка фотографий (до 3)
- Валидация в реальном времени
- Модальное окно или отдельная страница

#### 1.3.3. Список отзывов
**src/components/reviews/ReviewsList.tsx**
- Карточки отзывов
- Фильтры: все, 5 звезд, 4 звезды, и т.д.
- Сортировка: новые, старые, полезные
- Пагинация
- Кнопка "Показать больше"

#### 1.3.4. Карточка отзыва
**src/components/reviews/ReviewCard.tsx**
- Рейтинг (звезды)
- Имя рейтера (анонимно или публично)
- Дата отзыва
- Заголовок и текст
- Фотографии (галерея)
- Ответ владельца (если есть)
- Кнопки: полезно, пожаловаться
- Редактирование (если автор)

#### 1.3.5. Статистика рейтингов
**src/components/reviews/RatingSummary.tsx**
- Средний рейтинг (большой)
- Распределение по звездам (график)
- Общее количество отзывов
- Процент положительных (4-5 звезд)

### 1.4. Интеграция

#### 1.4.1. Страница места
**src/app/spots/[id]/page.tsx**
- Добавить секцию с рейтингом и отзывами
- Показать средний рейтинг в заголовке
- Кнопка "Оставить отзыв" (если есть завершенное бронирование)
- Список отзывов внизу страницы

#### 1.4.2. Страница истории бронирований
**src/app/bookings/page.tsx**
- Кнопка "Оставить отзыв" для завершенных бронирований
- Индикатор, если отзыв уже оставлен

#### 1.4.3. Карточки мест
**src/components/ui/ParkingSpotCard.tsx**
- Отобразить средний рейтинг и количество отзывов
- Звезды рядом с названием

---

## 2. Избранное (Favorites)

### 2.1. Схема базы данных

**Модель Favorite:**
```prisma
model Favorite {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  spotId   String
  spot     ParkingSpot @relation(fields: [spotId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@unique([userId, spotId]) // Один пользователь может добавить место только один раз
  @@index([userId])
  @@index([spotId])
}
```

**Обновить модель User:**
```prisma
model User {
  // ... существующие поля
  favorites   Favorite[]
}
```

**Обновить модель ParkingSpot:**
```prisma
model ParkingSpot {
  // ... существующие поля
  favorites   Favorite[]
}
```

### 2.2. API Endpoints

#### 2.2.1. Добавить в избранное
**POST /api/favorites**
- Требуется авторизация
- Body: `{ spotId: string }`
- Проверка на дубликаты
- Возвращает статус добавления

#### 2.2.2. Удалить из избранного
**DELETE /api/favorites/[spotId]**
- Требуется авторизация
- Удаление по spotId

#### 2.2.3. Проверить статус избранного
**GET /api/favorites/[spotId]**
- Проверка, добавлено ли место в избранное
- Возвращает `{ isFavorite: boolean }`

#### 2.2.4. Список избранного
**GET /api/favorites**
- Параметры: `page`, `limit`
- Возвращает список мест из избранного
- Сортировка: по дате добавления (новые первыми)

### 2.3. UI Компоненты

#### 2.3.1. Кнопка избранного
**src/components/favorites/FavoriteButton.tsx**
- Иконка сердца (пустое/заполненное)
- Анимация при клике
- Состояния: loading, favorited, not favorited
- Оптимистичное обновление UI

#### 2.3.2. Страница избранного
**src/app/(me)/favorites/page.tsx**
- Список избранных мест
- Карточки мест (использовать ParkingSpotCard)
- Пустое состояние (если нет избранного)
- Фильтры и сортировка
- Удаление из избранного

#### 2.3.3. Быстрый доступ
- Добавить в мобильную навигацию
- Иконка избранного в хедере
- Счетчик количества избранных

### 2.4. Интеграция

#### 2.4.1. Карточки мест
**src/components/ui/ParkingSpotCard.tsx**
- Кнопка избранного в углу карточки
- Сохранение состояния при перезагрузке

#### 2.4.2. Страница места
**src/app/spots/[id]/page.tsx**
- Кнопка избранного рядом с кнопкой "Забронировать"
- Визуальная обратная связь

#### 2.4.3. Каталог
**src/app/catalog/page.tsx**
- Фильтр "Только избранное"
- Индикация избранных мест

#### 2.4.4. Карта
**src/components/map/LeafletMap.tsx**
- Фильтр показа только избранных мест
- Визуальное выделение избранных маркеров

---

## 3. Приоритеты реализации

### Фаза 1 (Критично) - MVP
1. ✅ Схема базы данных (Review, Favorite)
2. ✅ API для избранного (добавить/удалить/список)
3. ✅ Кнопка избранного в карточках
4. ✅ Страница избранного
5. ✅ API для отзывов (создание, получение)
6. ✅ Компонент отображения отзывов

### Фаза 2 (Важно)
7. Форма создания отзыва
8. Рейтинг в карточках мест
9. Статистика рейтингов
10. Ответы владельцев на отзывы

### Фаза 3 (Желательно)
11. Модерация отзывов
12. Полезность отзывов
13. Фотографии в отзывах
14. Редактирование отзывов

---

## 4. Технические детали

### 4.1. Валидация
- Рейтинг: 1-5 звезд, обязательное поле
- Комментарий: минимум 10, максимум 2000 символов
- Заголовок: максимум 100 символов
- Фотографии: максимум 3, формат JPG/PNG, размер до 5MB

### 4.2. Автомодерация
- Проверка на мат (библиотека или API)
- Проверка на спам (повторяющиеся символы, ссылки)
- Проверка на дубликаты (похожие отзывы)

### 4.3. Производительность
- Кэширование средних рейтингов
- Пагинация отзывов (по 10-20 на страницу)
- Оптимистичное обновление UI для избранного

### 4.4. Безопасность
- Проверка прав доступа (только автор может редактировать)
- Защита от спама (лимит отзывов в день)
- Валидация на сервере

---

## 5. UI/UX Рекомендации

### 5.1. Рейтинги
- Звезды должны быть интерактивными
- Показывать распределение рейтингов (график)
- Выделять полезные отзывы
- Показывать ответы владельцев отдельно

### 5.2. Избранное
- Визуальная обратная связь при добавлении
- Анимация сердца
- Счетчик в навигации
- Быстрый доступ из любого места

---

## 6. Тестирование

### 6.1. Unit тесты
- Валидация отзывов
- Расчет среднего рейтинга
- Проверка прав доступа

### 6.2. Integration тесты
- Создание отзыва после бронирования
- Добавление/удаление из избранного
- Получение списка отзывов

### 6.3. E2E тесты
- Полный флоу создания отзыва
- Добавление места в избранное и просмотр списка

---

## Заключение

Этот план обеспечивает полную реализацию системы рейтингов, отзывов и избранного. Реализация должна быть поэтапной, начиная с базового функционала (MVP), затем добавление улучшений и дополнительных возможностей.

