# План реализации системы бронирования

## Обзор
Полная проработка системы бронирования парковочных мест с интеграцией геолокации, маршрутизации и улучшенным UX.

---

## 1. Геолокация пользователя

### 1.1. API для получения геолокации
**Файл:** `src/lib/geolocation.ts`
- Функция `getUserLocation()` - запрос разрешения на геолокацию
- Функция `watchUserLocation(callback)` - отслеживание перемещения
- Обработка ошибок (разрешение отклонено, таймаут, недоступность)
- Кэширование последней известной позиции в localStorage
- Fallback на IP-геолокацию через внешний API

### 1.2. Компонент запроса геолокации
**Файл:** `src/components/booking/GeolocationPrompt.tsx`
- Модальное окно с запросом разрешения
- Кнопка "Разрешить геолокацию"
- Индикатор загрузки при получении координат
- Отображение текущих координат (опционально)
- Сохранение выбора пользователя (не спрашивать повторно)

### 1.3. Хук для геолокации
**Файл:** `src/hooks/useGeolocation.ts`
- `useGeolocation()` - React hook для работы с геолокацией
- Состояния: `loading`, `error`, `coordinates`, `accuracy`
- Автоматическое обновление при изменении позиции
- Debounce для частых обновлений

### 1.4. Сохранение в сессии/БД
**Схема Prisma:** Добавить в `User` модель:
```prisma
lastKnownLat Float?
lastKnownLng Float?
lastLocationUpdate DateTime?
```

---

## 2. Маршрутизация и навигация

### 2.1. Выбор провайдера маршрутизации
**Варианты:**
- **OSRM** (Open Source Routing Machine) - бесплатный, требует сервер
- **Mapbox Directions API** - платный, но качественный
- **Yandex Maps API** - для России оптимален, есть бесплатный тариф
- **Google Maps Directions API** - платный, но самый точный

**Рекомендация:** Yandex Maps API для России, с fallback на OSRM

### 2.2. API для маршрутизации
**Файл:** `src/lib/routing.ts`
- Функция `calculateRoute(from, to, mode)` - расчет маршрута
  - `mode`: `driving`, `walking`, `transit`
- Функция `getRouteDistance(route)` - расстояние в км
- Функция `getRouteDuration(route)` - время в минутах
- Кэширование маршрутов (избежать повторных запросов)
- Обработка ошибок (нет маршрута, недоступность API)

### 2.3. API endpoint для маршрутов
**Файл:** `src/app/api/routing/route.ts`
- `POST /api/routing` - расчет маршрута
- Параметры: `fromLat`, `fromLng`, `toLat`, `toLng`, `mode`
- Возвращает: `distance`, `duration`, `polyline`, `steps`
- Rate limiting для защиты от злоупотреблений

### 2.4. Компонент карты с маршрутом
**Файл:** `src/components/booking/RouteMap.tsx`
- Отображение точки старта (геолокация пользователя)
- Отображение точки назначения (парковочное место)
- Визуализация маршрута (линия на карте)
- Маркеры с подписями
- Информационная панель: расстояние, время в пути
- Кнопка "Открыть в навигаторе" (Yandex Maps, Google Maps, 2GIS)

### 2.5. Интеграция с Leaflet
**Файл:** `src/components/map/LeafletMap.tsx` (обновить)
- Добавить поддержку отображения маршрута
- Плагин `leaflet-routing-machine` или кастомная отрисовка
- Анимация построения маршрута
- Оптимизация зума для показа всего маршрута

---

## 3. UI бронирования

### 3.1. Улучшенная форма бронирования
**Файл:** `src/app/spots/[id]/page.tsx` (обновить)
- Автоматическое получение геолокации при открытии страницы
- Отображение времени в пути в реальном времени
- Предпросмотр стоимости с учетом времени
- Календарь доступности (выбор даты/времени)
- Валидация в реальном времени
- Индикатор загрузки при расчете маршрута

### 3.2. Компонент выбора времени
**Файл:** `src/components/booking/TimePicker.tsx`
- Календарь с выделением доступных дат
- Выбор времени начала и окончания
- Отображение занятых слотов
- Минимальная/максимальная длительность
- Быстрый выбор (1 час, 2 часа, 4 часа, сутки)

### 3.3. Панель информации о маршруте
**Файл:** `src/components/booking/RouteInfo.tsx`
- Расстояние до парковки
- Время в пути (с учетом текущего трафика)
- Стоимость поездки (опционально, если интегрирован такси)
- Кнопка "Построить маршрут"
- Обновление в реальном времени при изменении геолокации

### 3.4. Модальное окно подтверждения
**Файл:** `src/components/booking/BookingConfirmation.tsx`
- Сводка бронирования (дата, время, место, цена)
- Информация о маршруте
- Условия отмены
- Кнопка "Подтвердить бронирование"
- Обработка ошибок

---

## 4. Валидация и бизнес-логика

### 4.1. Расширенная валидация
**Файл:** `src/lib/validation.ts` (обновить)
- `bookingCreateSchema` - добавить проверки:
  - Минимальное время бронирования (например, 1 час)
  - Максимальное время бронирования (например, 30 дней)
  - Запрет бронирования в прошлом
  - Проверка доступности времени (нет конфликтов)
  - Валидация геолокации (если предоставлена)

### 4.2. Проверка доступности
**Файл:** `src/lib/availability.ts` (обновить)
- Функция `checkSpotAvailability(spotId, startAt, endAt)` - проверка свободности
- Учет существующих бронирований
- Учет блокировок владельца (blackouts)
- Учет правил доступности (AvailabilityRule)
- Возврат списка доступных временных слотов

### 4.3. API для проверки доступности
**Файл:** `src/app/api/spots/[id]/availability/route.ts`
- `GET /api/spots/[id]/availability?date=YYYY-MM-DD`
- Возвращает массив доступных временных интервалов
- Учитывает существующие бронирования и блокировки

### 4.4. Обработка конфликтов
**Файл:** `src/app/api/bookings/route.ts` (обновить)
- Детальная проверка перекрытий
- Информативные сообщения об ошибках
- Предложение альтернативных временных слотов
- Логирование конфликтов для аналитики

---

## 5. Расширенное ценообразование

### 5.1. Расчет депозита
**Файл:** `src/lib/pricing.ts` (обновить)
- Функция `calculateDeposit(totalPrice, spot)` - расчет депозита
- Процент от стоимости или фиксированная сумма
- Учет типа парковки (дорогая = больший депозит)

### 5.2. Динамическое ценообразование
- Учет времени суток (ночь дешевле)
- Учет дня недели (выходные дороже)
- Учет спроса (высокий спрос = выше цена)
- Скидки для постоянных клиентов

### 5.3. Отображение цены
**Компонент:** Обновить форму бронирования
- Разбивка стоимости:
  - Базовая цена за время
  - Комиссия платформы
  - Депозит (если требуется)
  - Итого к оплате
- Информация о возврате депозита

---

## 6. Уведомления

### 6.1. Email уведомления
**Файл:** `src/lib/notifications.ts` (обновить)
- При создании бронирования (арендатор и владелец)
- При подтверждении владельцем
- При отмене бронирования
- Напоминание за 1 час до начала
- Напоминание за 15 минут до окончания

### 6.2. Push уведомления
- Интеграция с браузерными Push API
- Уведомления в PWA
- Настройки пользователя (какие уведомления получать)

### 6.3. SMS уведомления (опционально)
- Интеграция с SMS-провайдером (Twilio, SMS.ru)
- Критичные уведомления (отмена, конфликты)

---

## 7. История бронирований

### 7.1. Страница истории
**Файл:** `src/app/bookings/page.tsx`
- Список всех бронирований пользователя
- Фильтры: статус, дата, место
- Сортировка: по дате, по статусу
- Поиск по названию места или адресу
- Пагинация

### 7.2. Детальная страница бронирования
**Файл:** `src/app/bookings/[id]/page.tsx`
- Полная информация о бронировании
- Карта с маршрутом (если была сохранена геолокация)
- История изменений статуса
- Возможность отмены (если разрешено)
- Чат с владельцем (опционально)

### 7.3. Компонент карточки бронирования
**Файл:** `src/components/booking/BookingCard.tsx`
- Компактное отображение информации
- Статус с цветовой индикацией
- Быстрые действия (отмена, детали)
- Ссылка на маршрут

---

## 8. Отмена и возвраты

### 8.1. Логика отмены
**Файл:** `src/app/api/bookings/[id]/cancel/route.ts`
- Проверка прав (только арендатор или владелец)
- Проверка возможности отмены (время до начала)
- Расчет возврата (с учетом политики отмены)
- Обновление статуса бронирования
- Освобождение временного слота

### 8.2. Политика отмены
**Схема Prisma:** Добавить в `ParkingSpot`:
```prisma
cancellationPolicy String // "FLEXIBLE", "MODERATE", "STRICT"
cancellationDeadlineHours Int // За сколько часов можно отменить
```

### 8.3. Расчет возврата
**Файл:** `src/lib/pricing.ts` (обновить)
- Функция `calculateRefund(booking, cancellationTime)`
- Учет политики отмены
- Комиссия платформы (возвращается или нет)
- Депозит (возвращается полностью)

### 8.4. UI отмены
**Компонент:** Модальное окно подтверждения отмены
- Причина отмены (опционально)
- Информация о возврате
- Подтверждение действия

---

## 9. Календарь доступности

### 9.1. Компонент календаря
**Файл:** `src/components/booking/AvailabilityCalendar.tsx`
- Визуализация доступных/занятых слотов
- Цветовая индикация:
  - Зеленый - доступно
  - Красный - занято
  - Желтый - частично занято
  - Серый - заблокировано владельцем
- Клик по слоту для быстрого бронирования
- Информация о цене для каждого дня

### 9.2. API для календаря
**Файл:** `src/app/api/spots/[id]/calendar/route.ts`
- `GET /api/spots/[id]/calendar?month=YYYY-MM`
- Возвращает матрицу доступности на месяц
- Учитывает все бронирования и блокировки

---

## 10. Мобильная оптимизация

### 10.1. Адаптивный UI
- Оптимизация формы бронирования для мобильных
- Упрощенный выбор времени
- Быстрый доступ к геолокации (кнопка на видном месте)
- Полноэкранная карта с маршрутом

### 10.2. Нативные функции
- Интеграция с нативными картами (открыть в приложении)
- Вибрация при успешном бронировании
- Сохранение в календарь устройства

---

## 11. Технические детали

### 11.1. Зависимости
```json
{
  "leaflet": "^1.9.4",
  "react-leaflet": "^4.2.1",
  "leaflet-routing-machine": "^3.2.12",
  "@types/leaflet-routing-machine": "^3.2.0"
}
```

### 11.2. Переменные окружения
```env
# Yandex Maps API
YANDEX_MAPS_API_KEY=your_key_here

# OSRM (fallback)
OSRM_SERVER_URL=https://router.project-osrm.org

# Геолокация
ENABLE_GEOLOCATION=true
GEOLOCATION_TIMEOUT=10000
GEOLOCATION_CACHE_TTL=3600000
```

### 11.3. Схема БД (дополнения)
```prisma
model Booking {
  // ... существующие поля
  renterLat Float?        // Геолокация арендатора при бронировании
  renterLng Float?
  routeDistance Float?     // Расстояние до парковки (км)
  routeDuration Int?       // Время в пути (минуты)
  routePolyline String?    // Полилиния маршрута (для отображения)
  cancellationReason String?
  refundAmount Int?
  refundedAt DateTime?
}
```

---

## 12. Приоритеты реализации

### Фаза 1 (Критично) - MVP
1. ✅ Геолокация пользователя
2. ✅ Маршрутизация (базовая)
3. ✅ UI бронирования с маршрутом
4. ✅ Отображение времени в пути

### Фаза 2 (Важно)
5. Календарь доступности
6. Расширенная валидация
7. История бронирований
8. Уведомления (email)

### Фаза 3 (Желательно)
9. Отмена и возвраты
10. Динамическое ценообразование
11. Push уведомления
12. Мобильная оптимизация

---

## 13. Тестирование

### 13.1. Unit тесты
- Валидация бронирований
- Расчет цены и депозита
- Проверка доступности

### 13.2. Integration тесты
- Создание бронирования с геолокацией
- Расчет маршрута
- Обработка конфликтов

### 13.3. E2E тесты
- Полный флоу бронирования
- Отмена бронирования
- Проверка уведомлений

---

## 14. Документация

- API документация для маршрутизации
- Руководство пользователя по бронированию
- Инструкция для владельцев (как управлять доступностью)

---

## Заключение

Этот план обеспечивает полную проработку системы бронирования с учетом всех требований, включая геолокацию и маршрутизацию. Реализация должна быть поэтапной, начиная с критичных функций (MVP), затем добавление улучшений и дополнительных возможностей.

